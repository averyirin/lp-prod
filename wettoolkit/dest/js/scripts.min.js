!function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(a,b){l.report[a].push(b)}function k(a){$("#"+a).parent().siblings(".active").removeClass("active"),$("[id='"+a+"']").parent().addClass("active")}d.isLoading=!1,tinyMCE.remove();var l=this;l.reports=a,l.report={},angular.copy(b,l.report),l.report.editable=[],l.rating=new i(l.report.ratings,5,d.user.id),l.datePicker=new h,l.dtOptions=g.newOptions().withOption("order",[[3,"desc"]]),l.removeFromList=function(a,b){l.report[b].splice(a,1),l.report.id&&l.update(b)},l.addToAnnex=function(){var a={presentation:"",summary:""};j("annex",a)},l.addToTravellers=function(){var a={rank:"",name:"",org:"",email:""};j("travellers",a)},l.addToItems=function(){var a={body:"",opi:{name:"",email:""}};j("issues_of_concern",a)},l.addToListSingleAttr=function(a){j(a,{body:""})},l.createReport=function(a){tinyMCE.triggerSave(),$("body").on("submit","form[name='tripReportForm']",function(){for(var b=0;b<l.report.discussions.length;b++)l.report.discussions[b].body=$(this).find("#discussion-"+b).val();for(var b=0;b<l.report.annex.length;b++)l.report.annex[b].summary=$(this).find("#item_summary-"+b).val();for(var b=0;b<l.report.issues_of_concern.length;b++)l.report.issues_of_concern[b].body||(l.report.issues_of_concern[b]={body:""});l.report.purpose=$(this).find("#purpose").val(),a&&(d.isLoading=!0,c.create({trip_report:l.report}).then(function(a){$(window).scrollTop(0),e.go("view",{id:a.id})},function(a){console.log(a)}))})},l.update=function(a){tinyMCE.triggerSave();var b={};if("discussions"==a||"annex"==a){b[a]=[];for(var d=0;d<l.report[a].length;d++)b[a][d]={},"discussions"==a?b[a][d].body=$("body").find("#discussion-"+d).val():"annex"==a&&(b[a][d].presentation=l.report[a][d].presentation,b[a][d].summary=$("body").find("#item_summary-"+d).val())}else b[a]="purpose"==a?$("body").find("#purpose").val():l.report[a];c.update(b,l.report.id).then(function(c){if("discussions"==a||"annex"==a)for(var d=0;d<b[a].length;d++)"discussions"==a?l.report[a][d].body=f.trustAsHtml(b[a][d].body):"annex"==a&&(l.report[a][d].summary=f.trustAsHtml(b[a][d].summary));else"purpose"==a&&(l.report[a]=f.trustAsHtml(b[a]))},function(a){console.log(a)})},l.updateRating=function(a){l.rating.addRating(a,d.user.id);var b=l.rating.getLatestRating();c.addRating({rating:b},l.report.id).then(function(a){l.report.ratings=a.ratings,l.rating.update()})},l["delete"]=function(a,b){c.remove(a).then(function(a){l.reports.splice(b,1)},function(a){console.log(a)})},l.filter=function(a){d.isLoading=!0;var b={};"mine"==a&&(b.owner_guid=d.user.id),c.getReports(b).then(function(b){l.reports=b,k(a),d.isLoading=!1},function(a){console.log(a),d.isLoading=!1})},l.toggleEditMode=function(a){var b=a.target.attributes["data-id"].value;l.report.editable[b]=l.report.editable[b]?!1:!0},l.cancelEdit=function(a){l.report[a]=b[a]},l.displayLoadingScreen=function(){d.isLoading=!0},l.highlightStars=function(a){l.rating.stars.highlightStars(a)},l.unhighlightStars=function(){l.rating.stars.unhighlightStars()}}angular.module("portal").controller("TripReportCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g){d.errorMessage=!1,d.message="";var h=this;h.user=b,b.data&&(h.user=b.data.user),h.registerUser=function(b){h.user.email!=h.email_verification&&(b=!1),b&&(d.isLoading=!0,a.register(h.user).then(function(b){a.disable(b.data.id).then(function(a){d.isLoading=!1,f.path("users/confirm/"+a.data.id+"?email="+a.data.email+"&name="+a.data.name)},function(a){console.log(a),d.isLoading=!1})},function(a){d.isLoading=!1;var b=a.data.data;d.message=b[0],d.errorMessage=!0}))},h.addProjectAdmin=function(b){a.update({project_admin:!0},b).then(function(a){h.selected_user=!1,$("#name").val(""),d.message="User has been added as a project admin",d.successMessage=!0,e(function(){d.successMessage=!1},5e3)},function(a){console.log(a)})},h.validateUser=function(){a.update({validated:!0},h.user.id).then(function(a){h.user.validated=!0,d.message="User has been validated",d.successMessage=!0,e(function(){d.successMessage=!1},1e4)},function(a){console.log(a)})},h.toggleUserStatus=function(b){a.update({deactivated:b},h.user.id).then(function(a){h.user.deactivated=b})}}angular.module("portal").controller("UserCtrl",a)}(),function(){"use strict";angular.module("portal").directive("emailValidation",function(){return{require:"ngModel",link:function(a,b,c,d){var e=["forces.gc.ca","canada.ca"];d.$parsers.unshift(function(a){var b=a.substring(a.lastIndexOf("@")+1),c=e.indexOf(b)>=0;return d.$setValidity("emailValidation",c),a})}}}),angular.module("portal").directive("passwordValidation",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){var b=a.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*[\d,.;:]).+$/),c=!1;if(b&&a.length>=8)var c=!0;return d.$setValidity("passwordValidation",c),a})}}}),angular.module("portal").directive("scrollToError",function(){return{restrict:"A",link:function(a,b){b.on("submit",function(){var a=$("#ng-app").offset().top;$("html, body").animate({scrollTop:a},500)})}}}),angular.module("portal").directive("ngFocusError",function(){return{restrict:"A",link:function(a,b){b.on("submit",function(){b.find(".ng-invalid:first").focus()})}}}),angular.module("portal").directive("mceInit",["$timeout",function(a){return{link:function(b,c,d){a(function(){tinymce.suffix=".min",tinymce.init({selector:"#"+d.id,theme:"modern",schema:"html5",plugins:["advlist link image charmap print preview hr anchor pagebreak","searchreplace wordcount visualblocks visualchars code fullscreen","insertdatetime media nonbreaking save table contextmenu directionality","emoticons template paste textcolor colorpicker textpattern imagetools jbimages jbvideos"],relative_urls:!1,toolbar1:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",toolbar2:"print preview media | forecolor backcolor emoticons imagetools jbimages jbvideos",image_advtab:!0,width:"100%",extended_valid_elements:"*[*]",remove_script_host:!1,document_base_url:elgg.config.wwwroot})},1e3)}}}]),angular.module("portal").directive("ngDeleteOnce",function(){return{priority:1,terminal:!0,link:function(a,b,c){var d=c.ngDeleteOnce||"Are you sure?",e=c.ngClick;b.bind("click",function(){window.confirm(d)&&(a.$eval(e),$(this).attr("disabled",!0))})}}})}(),function(){"use strict";function a(a,b){function c(b){var c={public_key:i},b="undefined"==typeof b?null:b;if(b)for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);var e=(angular.toJson(c),a("/portal/internapi/trip_reports",{},{query:{params:c}}));return e.query().$promise.then(function(a){return a.data.trip_reports},function(a){return a})}function d(b){var c={public_key:i},d=a("/portal/internapi/trip_reports/:id",{id:"@id"},{get:{params:c}});return d.get(null,{id:b}).$promise.then(function(a){var b=a.data.trip_report,c=["travellers","opi","discussions","issues_of_concern","internal_to_sc","external_to_sc","annex"];for(var d in b)c.indexOf(d)>=0&&(b[d]?"":b[d]=[{}]);return b.ratings?"":b.ratings=[],b},function(a){return a})}function e(b){var c={public_key:i},d=a("/portal/internapi/trip_reports",{},{save:{method:"POST",params:c}});return d.save(b).$promise.then(function(a){return a.data.trip_report},function(a){return a})}function f(b,c){for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];e?"":b[d]=null}var f={public_key:i},g=a("/portal/internapi/trip_reports/:id",{id:"@id"},{update:{method:"PUT",params:f}});return g.update({id:c},b).$promise.then(function(a){return a},function(a){return a})}function g(b,c){var d={public_key:i},e=a("/portal/internapi/trip_reports/:id/ratings",{id:"@id"},{update:{method:"POST",params:d}});return e.update({id:c},b).$promise.then(function(a){return a.data},function(a){return a})}function h(b){var c={public_key:i},d=a("/portal/internapi/trip_reports/:id",{id:"@id"},{"delete":{method:"DELETE",params:c}});return d["delete"]({id:b}).$promise.then(function(a){return a},function(a){return a})}var i=localStorage.getItem("publicKey");return i||(i=elgg.get_logged_in_user_guid()),{getReports:c,getReport:d,create:e,update:f,addRating:g,remove:h}}angular.module("portal").factory("tripReportService",a)}(),function(){"use strict";function a(a,b){function c(b){var c={public_key:h};if(b="undefined"==typeof b?null:b)for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);var e=(angular.toJson(c),a("/portal/internapi/users",{},{query:{params:c}}));return e.query().$promise.then(function(a){return a},function(a){return a})}function d(c){var d={public_key:h},e=a("/portal/internapi/users/:id",{id:"@id"},{get:{params:d}});return e.get(null,{id:c}).$promise.then(function(a){return a},function(a){return b.reject(a)})}function e(c,d){c.public_key=h;var e=(angular.toJson(c),a("/portal/internapi/users/:id",{id:"@id"},{update:{method:"PUT"}}));return e.update({id:d},c).$promise.then(function(a){return a},function(a){return b.reject(a)})}function f(c){var d=a("api/users");return d.save(c).$promise.then(function(a){return a},function(a){return b.reject(a)})}function g(c){var d=a("api/users/:id/disable",{id:"@id"},{disable:{method:"PUT"}});return d.disable({id:c}).$promise.then(function(a){return a},function(a){return b.reject(a)})}{var h=localStorage.getItem("publicKey");localStorage.getItem("privateKey")}return{getUsers:c,getUser:d,update:e,register:f,disable:g}}angular.module("portal").factory("user",a)}(),function(){"use strict";function a(a,b,c){function d(d,f,g){var h=d,i=f,j={subject:h,body:i,public_key:e,to_id:g},k=b.orderParams(j),l=(angular.toJson(k),a("internapi/notifications",{},{save:{method:"POST"}}));return l.save(j).$promise.then(function(a){return a},function(a){return c.reject(a)})}{var e=localStorage.getItem("publicKey");localStorage.getItem("privateKey")}return e||(e=elgg.get_logged_in_user_guid()),{create:d}}angular.module("portal").factory("notification",a)}();var DatePicker=function(){this.dateOptions={formatYear:"yy",maxDate:new Date(2020,5,22),minDate:new Date,startingDay:1},this.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],this.format=this.formats[0],this.altInputFormats=["M!/d!/yyyy"],this.popup1={},this.popup2={},this.open1=function(){this.popup1.opened=!0},this.open2=function(){this.popup2.opened=!0}};angular.module("portal").factory("DatePicker",function(){return DatePicker}),function(){"use strict";angular.module("portal").factory("Stars",function(){function a(a,b){this.stars=[],this.value=a,this.maxValue=b,this.createStars(this.value)}return a.prototype.createStars=function(a){for(var b=0;b<this.maxValue;b++)this.addStar({filled:a>b})},a.prototype.updateStars=function(a){for(var b=0;b<this.maxValue;b++)this.stars[b].filled=a>b},a.prototype.addStar=function(a){this.stars.push(a)},a.prototype.highlightStars=function(a){var b=this.getIndex(a);this.updateStars(b+1)},a.prototype.unhighlightStars=function(){this.updateStars(this.value)},a.prototype.getIndex=function(a){return this.stars.indexOf(a)},a.prototype.empty=function(){this.stars=[]},a})}(),function(){"use strict";angular.module("portal").factory("Rating",function(a){function b(a,b,c){this.ratings=a?a:[],this.stars=[],this.maxValue=b,this.userId=c,this.totalValue=0,this.numOfRatings=0,this.createRating()}return b.prototype.createRating=function(){var b=0;if(this.ratings.length>=1){for(var c=0,d=0;d<this.ratings.length;d++){var e=this.ratings[d];c+=e.value,this.numOfRatings+=1,e.user==this.userId&&(b=e.value)}this.totalValue=c/this.numOfRatings}this.stars=new a(b,this.maxValue)},b.prototype.update=function(){this.empty(),this.createRating()},b.prototype.addRating=function(a,b){for(var c=this.stars.stars.indexOf(a),d=c+1,e=0;e<this.ratings.length;e++){var f=this.ratings[e];b==f.user&&(this.ratings.splice(e,1),e-=1)}var f={value:d,user:b};this.ratings.push(f)},b.prototype.getLatestRating=function(){var a=this.ratings[this.ratings.length-1];return a},b.prototype.empty=function(){this.totalValue=0,this.userValue=0,this.numOfRatings=0,this.stars.empty()},b})}();